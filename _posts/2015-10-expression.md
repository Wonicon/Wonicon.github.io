---
layout: post
title: 四则运算表达式求值的几种方法
categories: 经验
tags: 编程
---

表达式求值是基础编程教学中喜闻乐见的题目. 我在各个场合, 已经遇到五六次类似的题目, 总共用过3种方法, 感受各不一样.

## 逆波兰表示法

第一次遇到逆波兰表示法是在离散数学课上, 不过用它来处理表达式求值则是在数据结构课上. 
这种方法, 需要维护一个栈来存储操作符. 它遇到数字符号是直接输出的, 但是遇到操作符, 则需要根据操作符优先级和栈的内容来, 对其行压栈和弹栈操作,  以在合适的位置上输出运算符. 

得到了逆波兰表示法的符号串后, 求值就变得很简单了. 只要先递归求左操作数, 再递归求右操作符, 然后按操作符运算即可. 
从中序表达式扫描生成后序表达式, 只需要线性事件, 栈的容量也不会超过表达式运算符的个数. 递归更是单向双尾递归, 没有回溯和冗余的调用. 

但是问题是优先级要维护栈内和栈外两套, 什么时候入栈, 什么时候出栈, 出栈到什么时候为止都是需要仔细考虑的细节. 
处理过程并不是非常的直观, 细节上的调试比较花时间, 需要加以练习......

这种方法我写过两次, 第一次是作业, 迷迷糊糊地过去了; 第二次是课堂测验, 调了半天后还是在若干测试样例后突然来了个错误的结果......

## 中序二叉树

普通的四则运算表达式可以画出二叉的抽象语法树, 内部结点都是运算符, 叶子结点都是值. 
位于根部的操作符最后处理, 与叶子结点邻接的内点则最先处理. 
所以可以看出根部的操作符优先级低, 根部的操作符优先级高. 

所以可以有两种直观的做法, 其一是先找到优先级最低的操作符, 递归求左右表达式的值, 然后处理; 
其二是先找到优先级最高的操作符, 先计算完成, 用结果的值替换进行计算的表达式串. 

这种写法符合正常人计算表达式的思路, 所以写起来很快, 不过要多次扫描符号串, 时间复杂度是$O(n^2)$的, 虽然常系数是0.5.

这种方法我写过4次, 写起来感觉还是不错的.

## 语法分析

上过编译原理的人都知道, ~~我们可以用parser generator秒杀这个问题, ~~ 我们可以通过设计文法和选择分析算法来分析表达式串. 
parser generator可以使用各种表驱动的算法, 比如LL(k), SLR, LR(k), LALR(k), ~~以及GLR~~等等, 不过手写的的确不是人干的事情. 
所以还老老实实地用递归下降法手写, 加上LL(1)的一些内容(向前看1个, FOLLOW集, 但是不用表), 
可以写出不需要回溯的递归下降过程, 毕竟表达式文法简单. 

不过文法要特殊处理下, 例如单独使用非终结符来体现数字和乘除法的高优先级. 另外由于LL的缺陷, 还需要消除做递归. 而消除了左递归, 
就得加入继承属性来处理语义行为. 感觉非常蛋疼, 但是非常廉价的让人体验到手写parser的快感的情景. 

由于基本上一个产生式对应一个分析函数, 所以语义信息比较丰富, 哪个函数里分析出错了能够比较准确的判断错误并且进行恢复. 

用编译器(前端)的概念来做表达式求值这道题, 虽然不怎么经济, 但是我感觉是最有意思的, 内容最丰富的.
